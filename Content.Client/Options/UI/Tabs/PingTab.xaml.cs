using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.DeadSpace.GhostRoleNotify.Prototypes;
using Robust.Shared.Prototypes;
using Robust.Shared.Configuration;
using Content.Shared.DeadSpace.CCCCVars;
using Content.Client.DeadSpace.NotifySystem.NotifyHelpers;
using Content.Client.Options.UI;

namespace Content.Client.Options.UI.Tabs;

[GenerateTypedNameReferences]

public sealed partial class PingTab : Control
{
    private readonly NotifyHelper _helper = NotifyHelperProvider.Helper;
    private bool _isSaveNeeded = false;
    private void AddCheckBox(string checkBoxName, string id, bool savedSelection)
    {
        CheckBox newCheckBox = new CheckBox() { Text = checkBoxName }; //Loc.GetString(checkBoxName) };
        newCheckBox.Pressed = savedSelection;
        newCheckBox.OnToggled += lol =>
        {
            _isSaveNeeded = true;
            _helper.SetValueAccess(id, newCheckBox.Pressed);
        };

        PingsCont.AddChild(newCheckBox);
    }
    private void AddSaveButton(Button ourButton, IConfigurationManager cfg)
    {
        ourButton.OnPressed += _ =>
        {
            if (_isSaveNeeded)
            {
                cfg.SetCVar(CCCCVars.SysNotifyCvar, _helper.PairListToString(_helper.GetDictionaryAccess()));
                cfg.SaveToFile();
            }
        };
    }
    public PingTab()
    {
        var prototypeManager = IoCManager.Resolve<IPrototypeManager>();
        var cfg = IoCManager.Resolve<IConfigurationManager>();
        _helper.EnsureInitialized(cfg, prototypeManager);
        RobustXamlLoader.Load(this);
        AddSaveButton(SaveButton, cfg);
        foreach (var proto in prototypeManager.EnumeratePrototypes<GhostRoleGroupNotify>())
        {
            AddCheckBox(proto.Name, proto.ID, _helper.GetValueAccess(proto.ID));
        }
        Control.Initialize();
    }
}
