// Мёртвый Космос, Licensed under custom terms with restrictions on public hosting and commercial use, full text: https://raw.githubusercontent.com/dead-space-server/space-station-14-fobos/master/LICENSE.TXT
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Content.Shared.DeadSpace.GhostRoleNotify.Prototypes;
using Robust.Shared.Prototypes;
using Robust.Shared.Configuration;
using Content.Shared.DeadSpace.CCCCVars;
using Content.Client.DeadSpace.NotifySystem.NotifyHelpers;
using Content.Client.Options.UI;

namespace Content.Client.Options.UI.Tabs;

[GenerateTypedNameReferences]

public sealed partial class PingTab : Control
{
    //private readonly NotifyHelper _helper = NotifyHelperProvider.Helper;
    private bool _isSaveNeeded = false;
    private void AddCheckBox(INotifyHelper _helper, string checkBoxName, string id, bool savedSelection)
    {
        CheckBox newCheckBox = new CheckBox() { Text = checkBoxName }; //Loc.GetString(checkBoxName) };
        newCheckBox.Pressed = savedSelection;
        newCheckBox.OnToggled += _ =>
        {
            _isSaveNeeded = true;
            _helper.SetValueAccess(id, newCheckBox.Pressed);
        };

        PingsCont.AddChild(newCheckBox);
    }
    private void AddSaveButton(Button ourButton, IConfigurationManager cfg, INotifyHelper _helper)
    {
        ourButton.OnPressed += _ =>
        {
            if (_isSaveNeeded)
            {
                _isSaveNeeded = false;
                cfg.SetCVar(CCCCVars.SysNotifyCvar, _helper.PairListToString(_helper.GetDictionaryAccess()));
                cfg.SaveToFile();
            }
        };
    }
    public PingTab()
    {
        var prototypeManager = IoCManager.Resolve<IPrototypeManager>();
        var cfg = IoCManager.Resolve<IConfigurationManager>();
        var _helper = IoCManager.Resolve<INotifyHelper>();
        _helper.EnsureInitialized();
        RobustXamlLoader.Load(this);
        AddSaveButton(SaveButton, cfg, _helper);
        foreach (var proto in prototypeManager.EnumeratePrototypes<GhostRoleGroupNotify>())
        {
            AddCheckBox(_helper, proto.Name, proto.ID, _helper.GetValueAccess(proto.ID));
        }
        Control.Initialize();
    }
}